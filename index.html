<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tokyo Crumb Order Widget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #2b2520;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f4eee5;
    }

    .tc-widget {
      max-width: 560px;
      margin: 0 auto;
      padding: 20px 18px 24px;
      background: radial-gradient(circle at top left, #f9f2e7 0, #e0c9b0 45%, #c6a384 100%);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow:
        0 18px 45px rgba(61, 41, 25, 0.25),
        inset 0 0 0 1px rgba(255, 255, 255, 0.35);
      box-sizing: border-box;
    }

    .tc-header {
      margin-bottom: 16px;
      text-align: left;
    }

    .tc-kicker {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #4B2C1B;
      margin-bottom: 4px;
    }

    .tc-title {
      font-size: 1.5rem;
      color: #4B2C1B;
      font-weight: 700;
      margin: 0 0 4px;
    }

    .tc-subtitle {
      font-size: 0.86rem;
      color: #4B2C1B;
      margin: 0;
    }

    .product-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 16px 0 18px;
    }

    .product-card {
      background: rgba(255, 249, 235, 0.96);
      border-radius: 16px;
      padding: 11px 12px;
      border: 1px solid rgba(210, 185, 150, 0.55);
      display: grid;
      grid-template-columns: auto 1fr; /* ‚Üê keep 2-column layout */
      gap: 12px;
      align-items: center;
      box-shadow: 0 6px 18px rgba(102, 76, 52, 0.12);
    }

    .product-image-wrap {
      width: 80px;
      height: 80px;
      border-radius: 14px;
      overflow: hidden;
      background: #FFF9EC;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .product-image-wrap img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    .product-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .product-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .product-name {
      font-size: 0.96rem;
      font-weight: 600;
      color: #2b2520;
    }

    /* price now sits directly under the name */
    .product-price {
      font-size: 0.8rem;
      color: #4b2c1b;
      font-weight: 600;
      margin-top: 1px;
    }

    .product-note {
      font-size: 0.78rem;
      color: #8b6a4f;
      margin-top: 2px;
    }

    .badge-new {
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f6e2c0;
      color: #8a5a2e;
      border: 1px solid rgba(204, 158, 94, 0.8);
      white-space: nowrap;
    }

    .variant-select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(173, 138, 102, 0.65);
      padding: 6px 11px;
      font-size: 1rem;
      background: #faf3e9;
      box-sizing: border-box;
      color: #4a3827;
    }

    .variant-select:focus {
      outline: none;
      box-shadow: 0 0 0 1px rgba(173, 138, 102, 0.7);
    }

    .qty-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 6px;
    }

    .qty-controls {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fdf4e4;
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(226, 199, 159, 0.8);
    }

    .qty-btn {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: none;
      background: #e9d5b5;
      cursor: pointer;
      font-size: 16px;
      line-height: 24px;
      text-align: center;
      padding: 0;
      color: #3b2a1b;
    }

    .qty-btn:active {
      transform: scale(0.97);
    }

    .qty-value {
      min-width: 22px;
      text-align: center;
      font-size: 0.84rem;
      font-weight: 600;
      color: #3b2a1b;
    }

    .qty-hint {
      font-size: 0.74rem;
      color: #8c7d70;
      text-align: right;
      flex: 1;
      white-space: nowrap;
    }

    .cart-box {
      background: rgba(255, 252, 246, 0.96);
      border-radius: 18px;
      padding: 11px 12px 12px;
      border: 1px solid rgba(221, 197, 166, 0.8);
      margin-bottom: 14px;
      box-shadow: 0 10px 26px rgba(81, 57, 36, 0.18);
    }

    .cart-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .cart-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #3b2f25;
    }

    .cart-subtitle {
      font-size: 0.7rem;
      color: #8d7e71;
    }

    .cart-empty {
      font-size: 0.8rem;
      color: #817166;
      margin-top: 2px;
    }

    .cart-items {
      margin: 4px 0 8px;
      font-size: 0.8rem;
    }

    .cart-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin: 2px 0;
      color: #3b2f25;
    }

    .cart-row span {
      white-space: nowrap;
    }

    .cart-total {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 6px;
      color: #3b2a1b;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .field-label {
      font-size: 0.74rem;
      margin-bottom: 3px;
      color: #fff7ea;
      display: block;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    input, textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(230, 208, 177, 0.95);
      padding: 7px 9px;
      font-size: 0.84rem;
      box-sizing: border-box;
      font-family: inherit;
      background: rgba(255, 252, 246, 0.96);
      color: #2f2620;
    }

    input::placeholder,
    textarea::placeholder {
      color: #a59380;
      font-size: 0.8rem;
    }

    input:focus,
    textarea:focus {
      outline: none;
      box-shadow: 0 0 0 1px rgba(211, 177, 132, 0.95);
    }

    textarea {
      resize: vertical;
      min-height: 64px;
    }

    .btn-wa {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 11px 16px;
      font-size: 0.92rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: #1e8f4c;
      color: #ffffff;
      box-shadow:
        0 10px 24px rgba(21, 96, 55, 0.42),
        0 0 0 1px rgba(255, 255, 255, 0.22);
    }

    .btn-wa:active {
      transform: scale(0.98);
    }

    .btn-wa-label {
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.8rem;
    }

    .helper-text {
      font-size: 0.7rem;
      color: #fff3dd;
      margin-top: 7px;
      text-align: center;
    }

    /* üì± Mobile small tweaks, but keep 2-column card */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .tc-widget {
        padding: 16px 14px 20px;
        border-radius: 20px;
        box-shadow: 0 12px 26px rgba(61, 41, 25, 0.2);
      }

      .qty-hint {
        white-space: normal;
        text-align: left;
      }

      .cart-row span {
        white-space: normal;
      }

      /* Enhanced mobile styles for variant selection */
      .variant-row {
        margin-bottom: 12px;
      }

      .variant-select {
        font-size: 16px !important; /* Prevent zoom on iOS */
        padding: 12px 16px !important; /* Larger touch target */
        min-height: 44px; /* Apple recommended minimum touch target */
        width: 100%;
        border-radius: 12px;
        border: 2px solid rgba(173, 138, 102, 0.8);
        background: #faf3e9;
        color: #4a3827;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px;
        padding-right: 40px; /* Space for dropdown arrow */
      }

      .variant-select:focus {
        outline: none;
        border-color: rgba(173, 138, 102, 1);
        box-shadow: 0 0 0 3px rgba(173, 138, 102, 0.3);
      }
    }
  </style>
</head>
<body>
  <div class="tc-widget">
    <div class="tc-header">
      <div class="tc-kicker">Tokyo Crumb ¬∑ Pre-order</div>
      <h2 class="tc-title">Reserve Your Loaves</h2>
      <p class="tc-subtitle">
        Build your selection, share your details, and confirm your order via WhatsApp.
      </p>
    </div>

    <!-- PRODUCT LIST -->
    <div id="product-list" class="product-list"></div>

    <!-- CART SUMMARY -->
    <div class="cart-box">
      <div class="cart-title-row">
        <div class="cart-title">Order summary</div>
        <div class="cart-subtitle">Review your selection before sending</div>
      </div>
      <div id="cart-items" class="cart-items"></div>
      <div id="cart-empty" class="cart-empty">Your cart is currently empty.</div>
      <div id="cart-total-row" class="cart-total" style="display:none;">
        <span>Subtotal</span>
        <span id="cart-total"></span>
      </div>
    </div>

    <!-- CUSTOMER INFO -->
    <div class="info-grid">
      <div>
        <label class="field-label" for="customerName">Name</label>
        <input id="customerName" type="text" placeholder="Recipient full name" />
      </div>
      <div>
        <label class="field-label" for="customerAddress">Delivery address</label>
        <textarea id="customerAddress" placeholder="Street, house number, building, and clear delivery details"></textarea>
      </div>
      <div>
        <label class="field-label" for="customerDeliveryDate">Delivery date</label>
        <input id="customerDeliveryDate" type="date" />
      </div>
      <div>
        <label class="field-label" for="customerNotes">Notes (optional)</label>
        <textarea id="customerNotes" placeholder="Preferred delivery time, gate instructions, or other requests"></textarea>
      </div>
    </div>

    <!-- WHATSAPP CTA -->
    <button id="waButton" class="btn-wa">
      <span class="btn-wa-label">Send order via WhatsApp</span>
    </button>

    <div class="helper-text">
      A draft order will open in WhatsApp for you to review and confirm with the Tokyo Crumb team.
    </div>
  </div>

  <script>
    // Change to your WhatsApp number (no +, no leading 0)
    const WHATSAPP_NUMBER = "6281299933389";

    // Product list
    const products = [
      {
        id: "white-bread",
        name: "White Bread",
        image: "https://res.cloudinary.com/dodmwwp1w/image/upload/v1764508463/Screenshot_2025-11-30_at_20.13.00_sbwvlj.png",
        note: "Soft Japanese-style white loaf.",
        isNew: true,
        variants: [
          { size: "Whole sliced loaf", price: 79000 },
          { size: "2-slice pack", price: 20000 }
        ]
      },
      {
        id: "wheat-bread",
        name: "Wheat Bread",
        image: "https://res.cloudinary.com/dodmwwp1w/image/upload/v1764508463/Screenshot_2025-11-30_at_20.13.21_ouy9zy.png",
        note: "Light wheat loaf with a tender crumb.",
        isNew: true,
        variants: [
          { size: "Whole sliced loaf", price: 89000 },
          { size: "2-slice pack", price: 20000 }
        ]
      },
      {
        id: "cheese-filled-bread",
        name: "Cheese-filled Bread",
        image: "https://res.cloudinary.com/dodmwwp1w/image/upload/v1764508463/Screenshot_2025-11-30_at_20.13.09_wyv3q7.png",
        note: "Rich cheese filling layered through the loaf.",
        isNew: true,
        variants: [
          { size: "Whole sliced loaf", price: 89000 },
          { size: "2-slice pack", price: 20000 }
        ]
      },
      {
        id: "chocolate-filled-bread",
        name: "Chocolate-filled Bread",
        image: "https://res.cloudinary.com/dodmwwp1w/image/upload/v1764508463/Screenshot_2025-11-30_at_20.13.14_h7e0gp.png",
        note: "Soft loaf with smooth chocolate filling.",
        isNew: true,
        variants: [
          { size: "Whole sliced loaf", price: 89000 },
          { size: "2-slice pack", price: 20000 }
        ]
      },
      {
        id: "vegan-wheat-bread",
        name: "Vegan Wheat Bread",
        image: "https://res.cloudinary.com/dodmwwp1w/image/upload/v1764508463/Screenshot_2025-11-30_at_20.13.37_qjzy5a.png",
        note: "Plant-based loaf with seeds and nuts.",
        isNew: true,
        variants: [
          { size: "Whole sliced loaf", price: 89000 },
          { size: "2-slice pack", price: 20000 }
        ]
      }
    ];

    const cart = {};              // key: productId__variantIndex -> quantity
    const selectedVariants = {};  // productId -> variantIndex

    function formatIDR(value) {
      return "Rp " + value.toLocaleString("id-ID");
    }

    function renderProducts() {
      const list = document.getElementById("product-list");
      list.innerHTML = "";

      products.forEach((p) => {
        const selectedIndex = selectedVariants[p.id] ?? 0;
        const key = `${p.id}__${selectedIndex}`;
        const qty = cart[key] || 0;
        const currentVariant = p.variants[selectedIndex];

        const card = document.createElement("div");
        card.className = "product-card";

        const imgWrap = document.createElement("div");
        imgWrap.className = "product-image-wrap";
        const img = document.createElement("img");
        img.src = p.image;
        img.alt = p.name;
        imgWrap.appendChild(img);

        const content = document.createElement("div");
        content.className = "product-content";

        const topRow = document.createElement("div");
        topRow.className = "product-top";

        const left = document.createElement("div");
        const nameEl = document.createElement("div");
        nameEl.className = "product-name";
        nameEl.textContent = p.name;

        const priceEl = document.createElement("div");
        priceEl.className = "product-price";
        priceEl.textContent = currentVariant ? formatIDR(currentVariant.price) : "";

        const noteEl = document.createElement("div");
        noteEl.className = "product-note";
        noteEl.textContent = p.note;

        left.appendChild(nameEl);
        left.appendChild(priceEl);   // price directly under name
        left.appendChild(noteEl);

        const rightTop = document.createElement("div");
        rightTop.style.display = "flex";
        rightTop.style.flexDirection = "column";
        rightTop.style.alignItems = "flex-end";
        rightTop.style.gap = "4px";

        if (p.isNew) {
          const badge = document.createElement("span");
          badge.className = "badge-new";
          badge.textContent = "New";
          rightTop.appendChild(badge);
        }

        const variantSelect = document.createElement("select");
        variantSelect.className = "variant-select";
        p.variants.forEach((v, index) => {
          const opt = document.createElement("option");
          opt.value = String(index);
          opt.textContent = v.size; // only size, price shown separately
          if (index === selectedIndex) opt.selected = true;
          variantSelect.appendChild(opt);
        });

        variantSelect.addEventListener("change", (e) => {
          const newIndex = parseInt(e.target.value, 10);
          selectedVariants[p.id] = newIndex;
          renderProducts();
          renderCart();
        });

        topRow.appendChild(left);
        topRow.appendChild(rightTop);
        content.appendChild(topRow);

        // Create variant selector row for better mobile visibility
        const variantRow = document.createElement("div");
        variantRow.className = "variant-row";
        variantRow.appendChild(variantSelect);
        content.appendChild(variantRow);

        const qtyRow = document.createElement("div");
        qtyRow.className = "qty-row";

        const qtyControls = document.createElement("div");
        qtyControls.className = "qty-controls";

        const minusBtn = document.createElement("button");
        minusBtn.className = "qty-btn";
        minusBtn.textContent = "‚àí";
        minusBtn.onclick = () => updateQuantity(p.id, selectedIndex, (cart[key] || 0) - 1);

        const qtyVal = document.createElement("span");
        qtyVal.className = "qty-value";
        qtyVal.textContent = qty;

        const plusBtn = document.createElement("button");
        plusBtn.className = "qty-btn";
        plusBtn.textContent = "+";
        plusBtn.onclick = () => updateQuantity(p.id, selectedIndex, (cart[key] || 0) + 1);

        qtyControls.appendChild(minusBtn);
        qtyControls.appendChild(qtyVal);
        qtyControls.appendChild(plusBtn);

        const hint = document.createElement("span");
        hint.className = "qty-hint";
        hint.textContent = "Per selected size";

        qtyRow.appendChild(qtyControls);
        qtyRow.appendChild(hint);
        content.appendChild(qtyRow);

        card.appendChild(imgWrap);
        card.appendChild(content);

        list.appendChild(card);
      });
    }

    function updateQuantity(productId, variantIndex, newQty) {
      const key = `${productId}__${variantIndex}`;
      if (newQty <= 0) {
        delete cart[key];
      } else {
        cart[key] = newQty;
      }
      renderProducts();
      renderCart();
    }

    function renderCart() {
      const cartItemsEl = document.getElementById("cart-items");
      const cartEmptyEl = document.getElementById("cart-empty");
      const cartTotalRow = document.getElementById("cart-total-row");
      const cartTotalEl = document.getElementById("cart-total");

      const entries = Object.entries(cart);
      if (entries.length === 0) {
        cartItemsEl.innerHTML = "";
        cartEmptyEl.style.display = "block";
        cartTotalRow.style.display = "none";
        return;
      }

      cartEmptyEl.style.display = "none";
      cartItemsEl.innerHTML = "";
      let total = 0;

      entries.forEach(([key, qty]) => {
        const [productId, variantIndexStr] = key.split("__");
        const variantIndex = parseInt(variantIndexStr, 10);
        const p = products.find((prod) => prod.id === productId);
        if (!p) return;
        const variant = p.variants[variantIndex];
        if (!variant) return;

        const lineTotal = variant.price * qty;
        total += lineTotal;

        const row = document.createElement("div");
        row.className = "cart-row";

        const left = document.createElement("span");
        left.textContent = `${qty} √ó ${p.name} (${variant.size})`;

        const right = document.createElement("span");
        right.textContent = formatIDR(lineTotal);

        row.appendChild(left);
        row.appendChild(right);
        cartItemsEl.appendChild(row);
      });

      cartTotalEl.textContent = formatIDR(total);
      cartTotalRow.style.display = "flex";
    }

    function buildWhatsAppMessage() {
      const entries = Object.entries(cart);
      if (entries.length === 0) {
        alert("Your cart is empty. Please add at least one item before sending your order.");
        return null;
      }

      const name = document.getElementById("customerName").value.trim();
      const address = document.getElementById("customerAddress").value.trim();
      const deliveryDate = document.getElementById("customerDeliveryDate").value.trim();
      const notes = document.getElementById("customerNotes").value.trim();

      if (!name || !address || !deliveryDate) {
        alert("Please fill in your name, delivery address, and delivery date before continuing.");
        return null;
      }

      // Validate delivery date is within allowed range
      const selectedDate = new Date(deliveryDate);
      const today = new Date();
      const maxDate = new Date();
      maxDate.setDate(today.getDate() + 7);
      
      // Reset time to compare dates only
      selectedDate.setHours(0, 0, 0, 0);
      today.setHours(0, 0, 0, 0);
      maxDate.setHours(0, 0, 0, 0);
      
      if (selectedDate < today) {
        alert("Delivery date cannot be in the past. Please select today or a future date.");
        return null;
      }
      
      if (selectedDate > maxDate) {
        alert("Delivery date cannot be more than 7 days ahead. Please select an earlier date.");
        return null;
      }

      // Format delivery date for display
      const formattedDate = selectedDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      let message = "Hello Tokyo Crumb,\nI'd like to place the following order:\n\n";
      let total = 0;

      entries.forEach(([key, qty]) => {
        const [productId, variantIndexStr] = key.split("__");
        const variantIndex = parseInt(variantIndexStr, 10);
        const p = products.find((prod) => prod.id === productId);
        if (!p) return;
        const variant = p.variants[variantIndex];
        if (!variant) return;

        const lineTotal = variant.price * qty;
        total += lineTotal;

        message += `‚Ä¢ ${qty} √ó ${p.name} (${variant.size}) @ ${formatIDR(variant.price)} = ${formatIDR(lineTotal)}\n`;
      });

      message += `\nSubtotal: ${formatIDR(total)}\n\n`;
      message += `Name: ${name}\n`;
      message += `Delivery address: ${address}\n`;
      message += `Delivery date: ${formattedDate}\n`;
      if (notes) {
        message += `Notes: ${notes}\n`;
      }
      message += "\nKindly confirm availability, delivery timing, and shipping fee. Thank you.";

      return message;
    }

    function setDeliveryDateConstraints() {
      const deliveryDateInput = document.getElementById("customerDeliveryDate");
      const today = new Date();
      const maxDate = new Date();
      maxDate.setDate(today.getDate() + 7);
      
      // Format dates for date input (YYYY-MM-DD)
      const todayStr = today.toISOString().split('T')[0];
      const maxDateStr = maxDate.toISOString().split('T')[0];
      
      deliveryDateInput.min = todayStr;
      deliveryDateInput.max = maxDateStr;
    }

    document.getElementById("waButton").addEventListener("click", () => {
      const text = buildWhatsAppMessage();
      if (!text) return;

      const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank");
    });

    // Initial setup
    products.forEach(p => {
      selectedVariants[p.id] = 0;
    });
    renderProducts();
    renderCart();
    setDeliveryDateConstraints();
  </script>
</body>
</html>
